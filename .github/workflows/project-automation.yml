name: Project Board Automation

on:
  issues:
    types: [opened, closed, reopened]
  pull_request:
    types: [opened, closed, reopened, converted_to_draft, ready_for_review]

permissions:
  issues: write
  pull-requests: write
  contents: read
  repository-projects: write

jobs:
  add-to-project:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - name: Add to Project
        uses: actions/add-to-project@v1.0.2
        with:
          # Set your project URL here when you create a project
          # Example: https://github.com/users/shand-j/projects/1
          project-url: https://github.com/users/shand-j/projects/1
          github-token: ${{ secrets.GITHUB_TOKEN }}
          
  update-status:
    runs-on: ubuntu-latest
    steps:
      - name: Set Initial Status
        if: github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          script: |
            // This is a placeholder for project field updates
            // GitHub Projects v2 API requires GraphQL
            console.log('Issue/PR opened - would set status to: Backlog');
            
      - name: Set In Progress Status
        if: (github.event_name == 'issues' && github.event.issue.assignees.length > 0) || (github.event_name == 'pull_request' && github.event.action == 'ready_for_review')
        uses: actions/github-script@v7
        with:
          script: |
            console.log('Would set status to: In Progress');
            
      - name: Set Done Status
        if: github.event.action == 'closed'
        uses: actions/github-script@v7
        with:
          script: |
            console.log('Would set status to: Done');

  validate-governance-issue:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && contains(github.event.issue.title, '[GOVERNANCE]') && github.event.action == 'opened'
    steps:
      - name: Validate Required Fields
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';
            
            // Check for required fields in governance issues
            const requiredFields = [
              'Target Start Date',
              'Target Due Date',
              'Acceptance Criteria',
              'Implementation Plan'
            ];
            
            const missingFields = requiredFields.filter(field => !body.includes(field));
            
            if (missingFields.length > 0) {
              const comment = `âš ï¸ **Governance Issue Validation**\n\nThe following required fields appear to be missing:\n${missingFields.map(f => `- ${f}`).join('\n')}\n\nPlease update the issue to include all required information.`;
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ['needs-info']
              });
            } else {
              const comment = `âœ… **Governance Issue Validated**\n\nAll required fields are present. This issue is ready for review.`;
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  notify-stakeholders:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'priority:critical')
    steps:
      - name: Notify on Critical Issues
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `ðŸš¨ **Critical Priority Issue**\n\nThis issue has been marked as critical priority. Relevant stakeholders have been notified.\n\ncc: @shand-j`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
